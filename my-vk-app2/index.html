<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ö–æ–ª–ª–µ–¥–∂–∞ –ò–ü–≠–ö</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .app {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #0077ff, #0055cc);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .back-button {
            position: absolute;
            left: 20px;
            top: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
        }
        
        /* –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ */
        .file-upload {
            padding: 30px 20px;
            text-align: center;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        
        .upload-button {
            background: #0077ff;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            transition: all 0.3s ease;
        }
        
        .upload-button:hover {
            background: #0055cc;
            transform: translateY(-2px);
        }
        
        .file-info {
            margin-top: 15px;
            color: #666;
            font-size: 14px;
        }
        
        .format-info {
            background: #e7f3ff;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
        }
        
        /* –í—ã–±–æ—Ä –≥—Ä—É–ø–ø—ã */
        .group-selection {
            padding: 20px;
            text-align: center;
        }
        
        .group-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .group-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .group-card:hover {
            border-color: #0077ff;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,119,255,0.2);
        }
        
        .group-card.selected {
            border-color: #0077ff;
            background: linear-gradient(135deg, #f8fbff, #e3f2fd);
        }
        
        .group-name {
            font-size: 16px;
            font-weight: 600;
            color: #0077ff;
        }
        
        /* –¢–∞–±–ª–∏—á–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ */
        .schedule-table-container {
            padding: 20px;
            overflow-x: auto;
        }
        
        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            background: white;
            min-width: 800px;
        }
        
        .schedule-table th {
            background: #0077ff;
            color: white;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            border: 1px solid #e9ecef;
            position: sticky;
            top: 0;
        }
        
        .schedule-table td {
            padding: 10px 8px;
            border: 1px solid #e9ecef;
            text-align: center;
            vertical-align: top;
            min-width: 120px;
        }
        
        .time-column {
            background: #f8f9fa;
            font-weight: 600;
            color: #0077ff;
            width: 100px;
            position: sticky;
            left: 0;
        }
        
        .pair-number {
            background: #e3f2fd;
            font-weight: 600;
            color: #0077ff;
        }
        
        .lesson-cell {
            min-height: 80px;
            background: #f8fbff;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .lesson-cell:hover {
            background: #e3f2fd;
        }
        
        .lesson-cell.has-lesson {
            background: #e8f5e8;
        }
        
        .lesson-subject {
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 4px;
            font-size: 13px;
        }
        
        .lesson-teacher {
            font-size: 11px;
            color: #666;
            font-style: italic;
            margin-bottom: 2px;
        }
        
        .lesson-room {
            font-size: 11px;
            color: #0077ff;
            background: rgba(0,119,255,0.1);
            padding: 2px 6px;
            border-radius: 4px;
            display: inline-block;
        }
        
        .empty-cell {
            background: #f8f9fa;
            color: #999;
            font-style: italic;
        }
        
        .group-header {
            background: #0055cc !important;
            white-space: nowrap;
        }
        
        /* –°—Ç–∞—Ç—É—Å */
        .status-bar {
            background: #f8f9fa;
            padding: 15px 20px;
            border-top: 1px solid #e9ecef;
            text-align: center;
            font-size: 14px;
            color: #666;
        }
        
        .loading {
            color: #0077ff;
            font-style: italic;
        }
        
        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .success {
            color: #155724;
            background: #d4edda;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        /* –≠–∫—Ä–∞–Ω */
        .screen {
            display: none;
        }
        
        .screen.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- –≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ -->
        <div class="screen active" id="uploadScreen">
            <div class="header">
                <h1>üéì –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ö–æ–ª–ª–µ–¥–∂–∞ –ò–ü–≠–ö</h1>
                <div class="subtitle">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è .docx</div>
            </div>
            
            <div class="file-upload">
                <input type="file" id="scheduleFile" accept=".docx,.doc" style="display: none;">
                <button class="upload-button" onclick="document.getElementById('scheduleFile').click()">
                    üìÅ –í—ã–±—Ä–∞—Ç—å DOCX —Ñ–∞–π–ª —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
                </button>
                
                <div class="format-info">
                    <strong>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:</strong><br>
                    ‚Ä¢ –§–∞–π–ª—ã .docx —Å —Ç–∞–±–ª–∏—Ü–∞–º–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è<br>
                    ‚Ä¢ –¢–∞–±–ª–∏—Ü—ã –¥–æ–ª–∂–Ω—ã —Å–æ–¥–µ—Ä–∂–∞—Ç—å –Ω–æ–º–µ—Ä–∞ –≥—Ä—É–ø–ø –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö
                </div>
                
                <div class="file-info" id="fileInfo">
                    –í—ã–±–µ—Ä–∏—Ç–µ DOCX —Ñ–∞–π–ª —Å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º
                </div>
            </div>
            
            <div class="status-bar">
                <div id="uploadStatus">–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞...</div>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ –≥—Ä—É–ø–ø—ã -->
        <div class="screen" id="groupScreen">
            <div class="header">
                <button class="back-button" onclick="showScreen('uploadScreen')">‚Üê –ù–∞–∑–∞–¥</button>
                <h1>üë• –í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É</h1>
                <div class="subtitle" id="scheduleDate">–î–∞—Ç–∞: ...</div>
            </div>
            
            <div class="group-selection">
                <div class="group-grid" id="groupGrid">
                    <!-- –ì—Ä—É–ø–ø—ã –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –ø–∞—Ä—Å–∏–Ω–≥–∞ -->
                </div>
            </div>
            
            <div class="status-bar">
                <div id="groupsCount">–ó–∞–≥—Ä—É–∂–µ–Ω–æ –≥—Ä—É–ø–ø: 0</div>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã -->
        <div class="screen" id="groupScheduleScreen">
            <div class="header">
                <button class="back-button" onclick="showScreen('groupScreen')">‚Üê –ù–∞–∑–∞–¥</button>
                <h1>üìö –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã</h1>
                <div class="subtitle" id="groupScheduleTitle">–ì—Ä—É–ø–ø–∞: ...</div>
            </div>
            
            <div class="schedule-table-container">
                <table class="schedule-table" id="groupScheduleTable">
                    <!-- –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å -->
                </table>
            </div>
            
            <div class="status-bar">
                <div id="scheduleStatus">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è...</div>
            </div>
        </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å DOCX -->
    <script src="https://unpkg.com/mammoth@1.4.17/mammoth.browser.min.js"></script>
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
    
    <script>
        // ==================== –ü–ê–†–°–ï–† DOCX –§–ê–ô–õ–û–í ====================
        class DocxScheduleParser {
            async parseDocxFile(file) {
                try {
                    const arrayBuffer = await this.readFileAsArrayBuffer(file);
                    const result = await mammoth.convertToHtml({arrayBuffer});
                    
                    if (result.value) {
                        return this.parseTableHTML(result.value);
                    } else {
                        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å DOCX —Ñ–∞–π–ª');
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ DOCX:', error);
                    throw error;
                }
            }
            
            readFileAsArrayBuffer(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        resolve(e.target.result);
                    };
                    reader.onerror = reject;
                    reader.readAsArrayBuffer(file);
                });
            }
            
            parseTableHTML(htmlText) {
                try {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(htmlText, 'text/html');
                    const tables = doc.querySelectorAll('table');
                    
                    console.log('–ù–∞–π–¥–µ–Ω–æ —Ç–∞–±–ª–∏—Ü –≤ DOCX:', tables.length);
                    
                    const schedules = [];
                    
                    tables.forEach((table, tableIndex) => {
                        try {
                            const schedule = this.parseTable(table, tableIndex);
                            if (schedule.groups.length > 0) {
                                schedules.push(schedule);
                            }
                        } catch (error) {
                            console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ç–∞–±–ª–∏—Ü—ã:', error);
                        }
                    });
                    
                    return schedules;
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ HTML –∏–∑ DOCX:', error);
                    return [];
                }
            }
            
            parseTable(table, tableIndex) {
                const rows = Array.from(table.querySelectorAll('tr'));
                const schedule = {
                    date: this.extractDate(rows),
                    groups: [],
                    pairs: []
                };
                
                // –ò—â–µ–º —Å—Ç—Ä–æ–∫—É —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ –≥—Ä—É–ø–ø
                let headerRowIndex = this.findHeaderRow(rows);
                if (headerRowIndex === -1) headerRowIndex = 0;
                
                const headerRow = rows[headerRowIndex];
                schedule.groups = this.parseGroupHeaders(headerRow);
                
                console.log(`–¢–∞–±–ª–∏—Ü–∞ ${tableIndex + 1}: –Ω–∞–π–¥–µ–Ω–æ ${schedule.groups.length} –≥—Ä—É–ø–ø`);
                
                // –ü–∞—Ä—Å–∏–º —Å—Ç—Ä–æ–∫–∏ —Å –ø–∞—Ä–∞–º–∏
                for (let i = headerRowIndex + 1; i < rows.length; i++) {
                    const pair = this.parsePairRow(rows[i], schedule.groups);
                    if (pair && (pair.time || pair.number || pair.rawTime)) {
                        schedule.pairs.push(pair);
                    }
                }
                
                return schedule;
            }
            
            findHeaderRow(rows) {
                for (let i = 0; i < Math.min(5, rows.length); i++) {
                    const cells = rows[i].querySelectorAll('td, th');
                    for (let cell of cells) {
                        if (this.isGroupName(cell.textContent)) {
                            return i;
                        }
                    }
                }
                return 0;
            }
            
            extractDate(rows) {
                // –ò—â–µ–º –¥–∞—Ç—É –≤ –ø–µ—Ä–≤—ã—Ö –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å—Ç—Ä–æ–∫–∞—Ö
                for (let i = 0; i < Math.min(3, rows.length); i++) {
                    const row = rows[i];
                    const cells = row.querySelectorAll('td, th');
                    
                    for (let cell of cells) {
                        const text = cell.textContent.trim();
                        if ((text.includes('–†–ê–°–ü–ò–°–ê–ù–ò–ï') || text.includes('—Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ')) && 
                            (text.includes('202') || text.match(/\d{1,2}\s+[–∞-—è]+\s+\d{4}/i))) {
                            
                            const dateMatch = text.match(/(\d{1,2}\s+[–∞-—è]+\s+\d{4})/i);
                            return dateMatch ? dateMatch[1] : '–¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞';
                        }
                    }
                }
                return '–¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞';
            }
            
            parseGroupHeaders(headerRow) {
                const groups = [];
                const cells = headerRow.querySelectorAll('td, th');
                
                for (let i = 0; i < cells.length; i++) {
                    const text = cells[i].textContent.trim();
                    if (this.isGroupName(text)) {
                        groups.push({
                            name: text,
                            index: i,
                            fullName: text
                        });
                    }
                }
                
                return groups;
            }
            
                parsePairRow(row, groups) {
        const cells = Array.from(row.querySelectorAll('td, th'));
        if (cells.length === 0) return null;
        
        const firstCell = cells[0];
        const firstCellText = firstCell.textContent.trim();
        const pairInfo = {
            time: this.extractTime(firstCellText),
            number: this.extractPairNumber(firstCellText),
            rawTime: firstCellText,
            lessons: []
        };
        
        // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–∞–≤–∏–ª—å–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –≤—Ä–µ–º—è
        if (!pairInfo.time && pairInfo.number) {
            // –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–æ–º–µ—Ä –ø–∞—Ä—ã, –Ω–æ –Ω–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –≤—Ä–µ–º—è
            pairInfo.time = this.getTimeByPairNumber(pairInfo.number);
        }
        
        // –î–ª—è –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã –Ω–∞—Ö–æ–¥–∏–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —è—á–µ–π–∫—É
        groups.forEach(group => {
            if (cells[group.index]) {
                const lessonText = cells[group.index].textContent.trim();
                const lesson = this.parseLesson(lessonText);
                pairInfo.lessons.push(lesson);
            } else {
                pairInfo.lessons.push(null);
            }
        });
        
        return pairInfo;
    }
    
    parseLesson(text) {
        const cleanText = text.trim();
        if (!cleanText || cleanText === '-' || cleanText === '‚Äî' || cleanText === '') {
            return null;
        }
        
        // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –£–ª—É—á—à–µ–Ω–Ω–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
        let subject = '';
        let teacher = '';
        let room = '';
        
        // –†–∞–∑–¥–µ–ª—è–µ–º –ø–æ –ø–µ—Ä–µ–Ω–æ—Å–∞–º —Å—Ç—Ä–æ–∫ –∏–ª–∏ —Ç–æ—á–∫–∞–º
        const lines = cleanText.split(/\n|\.\s+/).filter(line => line.trim());
        
        if (lines.length >= 1) {
            subject = lines[0].trim();
        }
        if (lines.length >= 2) {
            // –í—Ç–æ—Ä–∞—è —Å—Ç—Ä–æ–∫–∞ - –æ–±—ã—á–Ω–æ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å
            teacher = lines[1].trim();
        }
        if (lines.length >= 3) {
            // –¢—Ä–µ—Ç—å—è —Å—Ç—Ä–æ–∫–∞ - –æ–±—ã—á–Ω–æ –∞—É–¥–∏—Ç–æ—Ä–∏—è
            room = lines[2].trim();
        }
        
        // –ï—Å–ª–∏ –≤—Å—ë –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ, –ø—Ä–æ–±—É–µ–º —É–º–Ω–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ
        if (lines.length === 1) {
            return this.splitSingleLineLesson(cleanText);
        }
        
        // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ï—Å–ª–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—â–µ–º –≤ —Ç–µ–∫—Å—Ç–µ
        if (!teacher) {
            const teacherMatch = cleanText.match(/[–ê-–Ø–Å][–∞-—è—ë]+\s+[–ê-–Ø–Å]\.\s*[–ê-–Ø–Å]\./);
            if (teacherMatch) {
                teacher = teacherMatch[0];
                // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è –∏–∑ –ø—Ä–µ–¥–º–µ—Ç–∞
                subject = subject.replace(teacher, '').trim();
            }
        }
        
        // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—â–µ–º –∞—É–¥–∏—Ç–æ—Ä–∏—é
        if (!room) {
            const roomMatch = cleanText.match(/(\d+[–∞-—è]?|\d+\/\d+|[–ê-–Ø–∞-—è]+\s+[–∑–ó]–∞–ª|[–ê-–Ø–∞-—è]+\s+[–∞-—è]+)$/);
            if (roomMatch) {
                room = roomMatch[0].trim();
                // –£–±–∏—Ä–∞–µ–º –∞—É–¥–∏—Ç–æ—Ä–∏—é –∏–∑ –ø—Ä–µ–¥–º–µ—Ç–∞ –∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è
                subject = subject.replace(room, '').trim();
                if (teacher) {
                    teacher = teacher.replace(room, '').trim();
                }
            }
        }
        
        return {
            subject: subject || cleanText,
            teacher: teacher,
            room: room,
            rawText: cleanText
        };
    }
    
    // –ù–û–í–´–ô –ú–ï–¢–û–î: –£–º–Ω–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
    splitSingleLineLesson(text) {
        let subject = text;
        let teacher = '';
        let room = '';
        
        // –®–∞–±–ª–æ–Ω—ã –¥–ª—è –ø–æ–∏—Å–∫–∞
        const teacherPattern = /[–ê-–Ø–Å][–∞-—è—ë]+\s+[–ê-–Ø–Å]\.\s*[–ê-–Ø–Å]\./;
        const roomPattern = /(\d+[–∞-—è]?|\d+\/\d+|[–ê-–Ø–∞-—è]+\s+[–∑–ó]–∞–ª)$/;
        
        // –ò—â–µ–º –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è
        const teacherMatch = text.match(teacherPattern);
        if (teacherMatch) {
            teacher = teacherMatch[0];
            subject = subject.replace(teacher, '').trim();
        }
        
        // –ò—â–µ–º –∞—É–¥–∏—Ç–æ—Ä–∏—é –≤ –∫–æ–Ω—Ü–µ —Å—Ç—Ä–æ–∫–∏
        const roomMatch = text.match(roomPattern);
        if (roomMatch) {
            room = roomMatch[0];
            subject = subject.replace(room, '').trim();
            if (teacher) {
                teacher = teacher.replace(room, '').trim();
            }
        }
        
        // –ï—Å–ª–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–æ —Ñ–∞–º–∏–ª–∏–∏
        if (!teacher) {
            const words = text.split(' ');
            // –ò—â–µ–º —Å–ª–æ–≤–∞, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å —Ñ–∞–º–∏–ª–∏—è–º–∏ (—Å –∑–∞–≥–ª–∞–≤–Ω–æ–π –±—É–∫–≤—ã)
            const possibleTeachers = words.filter(word => 
                word.length > 2 && 
                word[0] === word[0].toUpperCase() && 
                !word.match(/\d/) &&
                !this.isSubjectWord(word)
            );
            
            if (possibleTeachers.length > 0) {
                teacher = possibleTeachers.join(' ');
                subject = subject.replace(teacher, '').trim();
            }
        }
        
        return {
            subject: subject || text,
            teacher: teacher,
            room: room,
            rawText: text
        };
    }
    
    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–ª—É–∂–µ–±–Ω—ã—Ö —Å–ª–æ–≤
    isSubjectWord(word) {
        const subjectWords = [
            '–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '—Ñ–∏–∑–∏–∫–∞', '–∏—Å—Ç–æ—Ä–∏—è', '—Ä—É—Å—Å–∫–∏–π', '–∞–Ω–≥–ª–∏–π—Å–∫–∏–π', '–ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞',
            '—Ñ–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞', '–±–∏–æ–ª–æ–≥–∏—è', '–æ–±—â–µ—Å—Ç–≤–æ–∑–Ω–∞–Ω–∏–µ', '—Ö–∏–º–∏—è'
        ];
        return subjectWords.includes(word.toLowerCase());
    }
    
    // –ù–û–í–´–ô –ú–ï–¢–û–î: –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –≤—Ä–µ–º—è –ø–æ –Ω–æ–º–µ—Ä—É –ø–∞—Ä—ã
    getTimeByPairNumber(pairNumber) {
        const times = {
            '1': '8:30 ‚Äì 10:00',
            '2': '10:10 ‚Äì 11:40', 
            '3': '12:00 ‚Äì 13:30',
            '4': '13:40 ‚Äì 15:10',
            '5': '15:30 ‚Äì 17:00',
            '6': '17:10 ‚Äì 18:40',
            '7': '18:50 ‚Äì 20:20'
        };
        return times[pairNumber] || '';
    }
    
    extractTime(text) {
        // –ò—â–µ–º –≤—Ä–µ–º—è –≤ —Ñ–æ—Ä–º–∞—Ç–∞—Ö: 8:30-10:00, 8.30-10.00, 8:30 ‚Äì 10:00
        const timeMatch = text.match(/(\d{1,2}[:.]\d{2})\s*[-‚Äì]\s*(\d{1,2}[:.]\d{2})/);
        if (timeMatch) {
            const startTime = timeMatch[1].replace('.', ':');
            const endTime = timeMatch[2].replace('.', ':');
            return `${startTime} ‚Äì ${endTime}`;
        }
        
        // –ò—â–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –æ—Ç–º–µ—Ç–∫–∏
        const singleTimeMatch = text.match(/(\d{1,2}[:.]\d{2})/);
        if (singleTimeMatch) {
            return singleTimeMatch[0].replace('.', ':');
        }
        
        return '';
    }
    
    extractPairNumber(text) {
        const pairMatch = text.match(/(\d)\s*–ø–∞—Ä–∞/);
        return pairMatch ? pairMatch[1] : '';
    }
            
            isGroupName(text) {
                const normalized = text.trim();
                return /^[–ê-–Ø–Å][–ê-–Ø–Å–∞-—è—ë]?-\d{2,3}-\d$/.test(normalized);
            }
        }

        // ==================== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ====================
        let scheduleParser = new DocxScheduleParser();
        let currentSchedules = [];
        let currentGroup = null;
        let allGroups = new Set();

        // ==================== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –§–ê–ô–õ–û–í ====================
        document.getElementById('scheduleFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                loadScheduleFile(file);
            }
        });

        async function loadScheduleFile(file) {
            showStatus('–ó–∞–≥—Ä—É–∑–∫–∞ DOCX —Ñ–∞–π–ª–∞...', 'loading');
            document.getElementById('fileInfo').textContent = `–§–∞–π–ª: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
            
            try {
                showStatus('–û–±—Ä–∞–±–æ—Ç–∫–∞ DOCX —Ñ–∞–π–ª–∞...', 'loading');
                
                // –ü–∞—Ä—Å–∏–º DOCX —Ñ–∞–π–ª
                currentSchedules = await scheduleParser.parseDocxFile(file);
                
                if (currentSchedules.length === 0) {
                    showStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Ç–∞–±–ª–∏—Ü—ã —Å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º –≤ —Ñ–∞–π–ª–µ.', 'error');
                    return;
                }
                
                // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –≥—Ä—É–ø–ø—ã
                allGroups.clear();
                currentSchedules.forEach(schedule => {
                    schedule.groups.forEach(group => {
                        allGroups.add(group.name);
                    });
                });
                
                showStatus(`–£—Å–ø–µ—à–Ω–æ! –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${currentSchedules.length} —Ç–∞–±–ª–∏—Ü, ${allGroups.size} –≥—Ä—É–ø–ø`, 'success');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –≥—Ä—É–ø–ø
                showGroupSelection();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                showStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ DOCX —Ñ–∞–π–ª–∞: ' + error.message, 'error');
            }
        }

        // ==================== –ü–û–ö–ê–ó –ì–†–£–ü–ü ====================
        function showGroupSelection() {
            const groupGrid = document.getElementById('groupGrid');
            const groupsCount = document.getElementById('groupsCount');
            const scheduleDate = document.getElementById('scheduleDate');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞—Ç—É –∏–∑ –ø–µ—Ä–≤–æ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
            if (currentSchedules.length > 0) {
                scheduleDate.textContent = `–î–∞—Ç–∞: ${currentSchedules[0].date}`;
            }
            
            // –û—á–∏—â–∞–µ–º –∏ –∑–∞–ø–æ–ª–Ω—è–µ–º —Å–µ—Ç–∫—É –≥—Ä—É–ø–ø
            groupGrid.innerHTML = '';
            const groupsArray = Array.from(allGroups).sort();
            
            groupsArray.forEach(groupName => {
                const groupCard = document.createElement('div');
                groupCard.className = 'group-card';
                groupCard.innerHTML = `<div class="group-name">${groupName}</div>`;
                groupCard.onclick = () => selectGroup(groupName);
                groupGrid.appendChild(groupCard);
            });
            
            groupsCount.textContent = `–ó–∞–≥—Ä—É–∂–µ–Ω–æ –≥—Ä—É–ø–ø: ${groupsArray.length}`;
            showScreen('groupScreen');
        }

        function selectGroup(groupName) {
            currentGroup = groupName;
            showGroupSchedule();
        }

       // ==================== –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ü–û–ö–ê–ó –†–ê–°–ü–ò–°–ê–ù–ò–Ø –ì–†–£–ü–ü–´ ====================
function showGroupSchedule() {
    const title = document.getElementById('groupScheduleTitle');
    const table = document.getElementById('groupScheduleTable');
    const status = document.getElementById('scheduleStatus');
    
    title.textContent = `–ì—Ä—É–ø–ø–∞: ${currentGroup}`;
    status.textContent = '–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è...';
    
    // –ù–∞—Ö–æ–¥–∏–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≥—Ä—É–ø–ø—ã
    let groupSchedule = null;
    let groupIndex = -1;
    
    for (let schedule of currentSchedules) {
        groupIndex = schedule.groups.findIndex(g => g.name === currentGroup);
        if (groupIndex !== -1) {
            groupSchedule = schedule;
            break;
        }
    }
    
    if (!groupSchedule) {
        table.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 40px; color: #666;">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≥—Ä—É–ø–ø—ã –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</td></tr>';
        status.textContent = '–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ';
        showScreen('groupScheduleScreen');
        return;
    }
    
    // –°—Ç—Ä–æ–∏–º —Ç–∞–±–ª–∏—Ü—É
    let html = `
        <tr>
            <th class="pair-number">–ü–∞—Ä–∞</th>
            <th class="time-column">–í—Ä–µ–º—è</th>
            <th>–ó–∞–Ω—è—Ç–∏–µ</th>
        </tr>
    `;
    
    let hasLessons = false;
    
    groupSchedule.pairs.forEach(pair => {
        const lesson = pair.lessons[groupIndex];
        // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
        const timeDisplay = pair.time || this.getTimeByPairNumber(pair.number) || pair.rawTime;
        const pairDisplay = pair.number ? `${pair.number} –ø–∞—Ä–∞` : '';
        
        if (lesson) {
            hasLessons = true;
            html += `
                <tr>
                    <td class="pair-number">${pairDisplay}</td>
                    <td class="time-column">${timeDisplay}</td>
                    <td class="lesson-cell has-lesson">
                        <div class="lesson-subject">${lesson.subject}</div>
                        ${lesson.teacher ? `<div class="lesson-teacher">üë®‚Äçüè´ ${lesson.teacher}</div>` : ''}
                        ${lesson.room ? `<div class="lesson-room">üè´ ${lesson.room}</div>` : ''}
                    </td>
                </tr>
            `;
        } else if (timeDisplay && timeDisplay.trim() && !timeDisplay.includes('–ø–∞—Ä–∞')) {
            html += `
                <tr>
                    <td class="pair-number">${pairDisplay}</td>
                    <td class="time-column">${timeDisplay}</td>
                    <td class="empty-cell">‚Äî</td>
                </tr>
            `;
        }
    });
    
    if (!hasLessons) {
        html = '<tr><td colspan="3" style="text-align: center; padding: 40px; color: #666;">–ù–µ—Ç –∑–∞–Ω—è—Ç–∏–π –Ω–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å</td></tr>';
    }
    
    table.innerHTML = html;
    status.textContent = `–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ (${groupSchedule.pairs.length} –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤)`;
    showScreen('groupScheduleScreen');
}

// –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–æ–¥ getTimeByPairNumber –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å
function getTimeByPairNumber(pairNumber) {
    const times = {
        '1': '8:30 ‚Äì 10:00',
        '2': '10:10 ‚Äì 11:40', 
        '3': '12:00 ‚Äì 13:30',
        '4': '13:40 ‚Äì 15:10',
        '5': '15:30 ‚Äì 17:00',
        '6': '17:10 ‚Äì 18:40',
        '7': '18:50 ‚Äì 20:20'
    };
    return times[pairNumber] || '';
}

        // ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        function showStatus(message, type = 'info') {
            const statusElement = document.getElementById('uploadStatus');
            statusElement.textContent = message;
            statusElement.className = type;
            
            // –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ —É—Å–ø–µ—à–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            if (type === 'success') {
                setTimeout(() => {
                    if (statusElement.textContent === message) {
                        statusElement.textContent = '';
                        statusElement.className = '';
                    }
                }, 5000);
            }
        }

        // ==================== VK BRIDGE –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof vkBridge !== 'undefined') {
                vkBridge.send('VKWebAppInit', {})
                    .then(() => console.log('VK Mini App –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω'))
                    .catch(error => console.error('–û—à–∏–±–∫–∞ VK:', error));
            } else {
                console.log('–ó–∞–ø—É—Å–∫ –≤ –±—Ä–∞—É–∑–µ—Ä–µ');
            }
            
            // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–¥–¥–µ—Ä–∂–∫–µ —Ñ–æ—Ä–º–∞—Ç–æ–≤
            console.log('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ –∑–∞–≥—Ä—É–∑–∫–µ DOCX —Ñ–∞–π–ª–æ–≤');
        });
    </script>
</body>
</html>